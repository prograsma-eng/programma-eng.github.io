<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prograsma123 | Comunidad de Devs Roblox</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
    <header style="padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); position: sticky; top:0; z-index:1000;">
        <h1 style="font-size: 1.2rem; color: var(--accent);">Prograsma123</h1>
        
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="auth-section" style="display: flex; align-items: center; gap: 10px;">
                <div id="user-display" style="cursor: pointer; font-size: 0.8rem; color: var(--accent); font-weight: bold; display: flex; align-items: center;">
                     Iniciar Sesi贸n
                </div>
                <button id="btn-logout" style="display:none; background:#ff444422; border:1px solid var(--danger); color:var(--danger); font-size:0.6rem; cursor:pointer; padding: 2px 5px; border-radius: 4px;">Salir</button>
            </div>

            <div class="notifications-wrapper" style="position: relative;">
                <button id="btn-campana" style="background:none; border:none; font-size: 1.3rem; cursor:pointer; position: relative;">
                     <span id="notif-count" style="display:none; position:absolute; top:0; right:0; background:red; color:white; font-size:0.6rem; border-radius:50%; padding:2px 5px; font-weight: bold;">0</span>
                </button>
                
                <div id="panel-notificaciones" style="display:none; position: absolute; right: 0; top: 40px; width: 280px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 2000; max-height: 400px; overflow-y: auto;">
                    <div style="padding: 10px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
                        <strong style="font-size: 0.8rem;">Notificaciones</strong>
                        <button id="btn-limpiar-notifs" style="background:none; border:none; color:var(--accent); font-size:0.7rem; cursor:pointer;">Limpiar</button>
                    </div>
                    <div id="lista-notificaciones" style="font-size: 0.75rem; color: #cbd5e1;">
                        <div style="padding: 20px; text-align: center; opacity: 0.5;">No hay notificaciones</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section id="publicar" class="tutorial-destacado">
            <div class="tutorial-content">
                <h2>Publicar Carpeta de Scripts </h2>
                <form id="form-proyecto" class="form-comunidad">
                    <div class="form-group">
                        <input type="text" id="autor" placeholder="Inicia sesi贸n para publicar" readonly required>
                        <input type="text" id="nombre-sistema" placeholder="Nombre del Sistema (ej: Gun System)" required>
                        <input type="password" id="clave-eliminar" placeholder="Clave para editar en el futuro" required>
                    </div>
                    <div id="lista-archivos-previa" style="margin: 10px 0; display: flex; flex-wrap: wrap; gap: 5px;"></div>
                    <div class="add-script-box" style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px dashed #334155;">
                        <div class="form-group">
                            <input type="text" id="temp-nombre" placeholder="Nombre (ej: MainClient)">
                            <select id="temp-tipo">
                                <option value="Script">Script</option>
                                <option value="LocalScript">LocalScript</option>
                                <option value="ModuleScript">ModuleScript</option>
                            </select>
                        </div>
                        <textarea id="temp-codigo" placeholder="Pega tu c贸digo Lua aqu铆..." rows="5" style="width:100%; margin-top:10px;"></textarea>
                        <button type="button" id="btn-agregar-archivo" class="btn-secundario" style="width:100%; margin-top:10px;">+ A帽adir este archivo a la carpeta</button>
                    </div>
                    <button type="submit" id="btn-publicar-todo" class="btn-main" style="display:none; width: 100%; margin-top:15px; background: var(--accent); color: #000;"> Publicar Sistema Completo</button>
                </form>
            </div>
        </section>

        <section id="comunidad" class="tutorial-destacado">
            <div class="tutorial-content">
                <h2 style="text-align: center; margin-bottom: 20px;">Biblioteca de la Comunidad</h2>
                <div class="search-container" style="margin-bottom: 30px;">
                    <input type="text" id="buscador" class="search-input" placeholder="Buscar por sistema o autor...">
                </div>
                <div id="contenedor-scripts"></div>
            </div>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDoc, updateDoc, increment, arrayUnion, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA6HiPcffZ6fCvaXm0RKjs2Zd-t_siSjb4",
            authDomain: "robloxcommunity-bb652.firebaseapp.com",
            projectId: "robloxcommunity-bb652",
            storageBucket: "robloxcommunity-bb652.firebasestorage.app",
            messagingSenderId: "114286923700",
            appId: "1:114286923700:web:d6cb6a07d36bf85e6b6ce1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const scriptsRef = collection(db, "scripts");
        const notifRef = collection(db, "notificaciones");

        let archivosTemporales = [];
        let todosLosProyectos = [];
        let autorLogueado = "Invitado";

        // --- AUTENTICACIN ---
        const userDisplay = document.getElementById('user-display');
        const btnLogout = document.getElementById('btn-logout');
        const inputAutor = document.getElementById('autor');

        userDisplay.onclick = async () => {
            if (autorLogueado === "Invitado") {
                try {
                    await signInWithPopup(auth, provider);
                } catch (e) { alert("Error al conectar con Google"); }
            }
        };

        btnLogout.onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                autorLogueado = user.displayName;
                userDisplay.innerHTML = `<img src="${user.photoURL}" style="width:20px; border-radius:50%; margin-right:8px;"> ${user.displayName}`;
                btnLogout.style.display = "block";
                inputAutor.value = user.displayName;
                escucharNotificaciones();
            } else {
                autorLogueado = "Invitado";
                userDisplay.innerHTML = " Iniciar Sesi贸n";
                btnLogout.style.display = "none";
                inputAutor.value = "";
                document.getElementById('lista-notificaciones').innerHTML = "Inicia sesi贸n para ver notificaciones.";
            }
        });

        // --- NOTIFICACIONES ---
        function escucharNotificaciones() {
            const q = query(notifRef, where("para", "==", autorLogueado), orderBy("fecha", "desc"));
            onSnapshot(q, (snap) => {
                const count = document.getElementById('notif-count');
                const lista = document.getElementById('lista-notificaciones');
                let unread = 0;
                
                if (snap.empty) {
                    lista.innerHTML = "<div style='padding:20px; text-align:center;'>No hay nada nuevo</div>";
                    count.style.display = "none";
                    return;
                }

                lista.innerHTML = snap.docs.map(d => {
                    const n = d.data();
                    if (!n.leida) unread++;
                    return `<div style="padding:12px; border-bottom:1px solid #334155; ${!n.leida ? 'background:#38bdf80a; border-left:3px solid var(--accent);' : ''}">
                        ${n.texto}<br><small style="opacity:0.5">${new Date(n.fecha).toLocaleTimeString()}</small>
                    </div>`;
                }).join('');

                count.innerText = unread;
                count.style.display = unread > 0 ? "block" : "none";
            });
        }

        document.getElementById('btn-limpiar-notifs').onclick = async () => {
            const q = query(notifRef, where("para", "==", autorLogueado), where("leida", "==", false));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.update(d.ref, { leida: true }));
            await batch.commit();
        };

        document.getElementById('btn-campana').onclick = (e) => {
            e.stopPropagation();
            const panel = document.getElementById('panel-notificaciones');
            panel.style.display = panel.style.display === "none" ? "block" : "none";
        };

        document.addEventListener('click', () => {
            document.getElementById('panel-notificaciones').style.display = "none";
        });

        // --- LGICA DE SCRIPTS ---
        document.getElementById('btn-agregar-archivo').onclick = () => {
            const n = document.getElementById('temp-nombre').value;
            const t = document.getElementById('temp-tipo').value;
            const c = document.getElementById('temp-codigo').value;
            if (!n || !c) return alert("Nombre y C贸digo obligatorios");
            
            archivosTemporales.push({ nombre: n, tipo: t, codigo: c });
            document.getElementById('temp-nombre').value = "";
            document.getElementById('temp-codigo').value = "";
            actualizarPrevia();
        };

        function actualizarPrevia() {
            const cont = document.getElementById('lista-archivos-previa');
            cont.innerHTML = archivosTemporales.map((f, i) => `
                <span style="background:var(--accent); color:#000; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">
                    ${f.nombre}.lua <span onclick="window.borrarTemp(${i})" style="cursor:pointer; margin-left:5px;"></span>
                </span>`).join('');
            document.getElementById('btn-publicar-todo').style.display = archivosTemporales.length > 0 ? "block" : "none";
        }

        window.borrarTemp = (i) => { archivosTemporales.splice(i, 1); actualizarPrevia(); };

        document.getElementById('form-proyecto').onsubmit = async (e) => {
            e.preventDefault();
            if (autorLogueado === "Invitado") return alert("Inicia sesi贸n primero");
            
            const btn = document.getElementById('btn-publicar-todo');
            btn.disabled = true;
            btn.innerText = "Subiendo...";

            await addDoc(scriptsRef, {
                autor: autorLogueado,
                nombreSistema: document.getElementById('nombre-sistema').value,
                clave: document.getElementById('clave-eliminar').value,
                archivos: archivosTemporales,
                likes: 0,
                comentarios: [],
                fecha: Date.now()
            });

            archivosTemporales = [];
            actualizarPrevia();
            e.target.reset();
            inputAutor.value = autorLogueado;
            btn.disabled = false;
            btn.innerText = " Publicar Sistema Completo";
            alert("隆Publicado con 茅xito!");
        };

        // --- RENDERIZADO (Biblioteca) ---
        onSnapshot(query(scriptsRef, orderBy("fecha", "desc")), (snap) => {
            todosLosProyectos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderizar(todosLosProyectos);
        });

        function renderizar(proyectos) {
            const cont = document.getElementById('contenedor-scripts');
            cont.innerHTML = proyectos.map(p => {
                const id = p.id;
                const files = p.archivos.map((f, i) => `
                    <div style="background:#0f172a; margin-bottom:5px; border-radius:4px; overflow:hidden; border:1px solid #1e293b;">
                        <div onclick="window.toggleCode('${id}-${i}')" style="padding:8px 12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:0.8rem;">
                            <span> <strong>${f.tipo}</strong> ${f.nombre}</span>
                            <button class="copy-btn" onclick="event.stopPropagation(); window.copy('${id}-${i}')">Copiar</button>
                        </div>
                        <pre id="code-${id}-${i}" style="display:none; margin:0; font-size:0.75rem;"><code class="language-lua">${f.codigo}</code></pre>
                    </div>
                `).join('');

                return `
                <div class="folder-block" style="background:var(--bg-card); border-radius:12px; padding:20px; margin-bottom:20px; border:1px solid #334155;">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
                        <div>
                            <h3 style="color:var(--accent); margin:0;"> ${p.nombreSistema}</h3>
                            <small style="opacity:0.6;">Por ${p.autor}</small>
                        </div>
                        <button onclick="window.darLike('${id}')" style="background:none; border:1px solid #334155; color:white; padding:5px 10px; border-radius:20px; cursor:pointer;">わ ${p.likes || 0}</button>
                    </div>
                    <div>${files}</div>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <input type="text" id="comm-${id}" placeholder="Escribe un comentario..." style="flex:1; background:#0f172a; border:1px solid #334155; color:white; padding:5px 10px; border-radius:4px; font-size:0.8rem;">
                        <button onclick="window.postComm('${id}')" class="btn-main" style="padding:5px 15px; font-size:0.8rem;">Post</button>
                    </div>
                </div>`;
            }).join('');
            if(window.Prism) Prism.highlightAll();
        }

        // --- FUNCIONES GLOBALES ---
        window.toggleCode = (id) => {
            const el = document.getElementById(`code-${id}`);
            el.style.display = el.style.display === "none" ? "block" : "none";
        };

        window.copy = (id) => {
            const text = document.getElementById(`code-${id}`).innerText;
            navigator.clipboard.writeText(text);
            alert("C贸digo copiado");
        };

        window.darLike = async (id) => {
            if (autorLogueado === "Invitado") return alert("Logueate");
            if (localStorage.getItem('L_'+id)) return alert("Ya diste like");
            const d = doc(db, "scripts", id);
            await updateDoc(d, { likes: increment(1) });
            localStorage.setItem('L_'+id, true);
            const snap = await getDoc(d);
            enviarNotif(snap.data().autor, `わ ${autorLogueado} dio like a tu sistema ${snap.data().nombreSistema}`);
        };

        window.postComm = async (id) => {
            if (autorLogueado === "Invitado") return alert("Logueate");
            const inp = document.getElementById(`comm-${id}`);
            if(!inp.value) return;
            const d = doc(db, "scripts", id);
            await updateDoc(d, { comentarios: arrayUnion({ user: autorLogueado, text: inp.value, date: Date.now() }) });
            const snap = await getDoc(d);
            enviarNotif(snap.data().autor, ` ${autorLogueado} coment贸 en ${snap.data().nombreSistema}`);
            inp.value = "";
        };

        async function enviarNotif(para, texto) {
            if (para === autorLogueado) return;
            await addDoc(notifRef, { para, texto, leida: false, fecha: Date.now() });
        }

        document.getElementById('buscador').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = todosLosProyectos.filter(p => 
                p.nombreSistema.toLowerCase().includes(val) || 
                p.autor.toLowerCase().includes(val)
            );
            renderizar(filtered);
        };
    </script>
</body>
</html>
